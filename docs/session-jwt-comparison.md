# セッション認証 vs JWT 認証 詳細比較

## 🎯 比較の目的

セッション/クッキー方式と JWT 方式の根本的な違いを理解し、適切な認証方式選択のための判断基準を身に付ける

---

## 📊 基本比較表

| 項目                 | セッション/クッキー        | JWT                              |
| :------------------- | :------------------------- | :------------------------------- |
| **状態管理**         | ステートフル（サーバー側） | ステートレス（トークン内包）     |
| **データ保存場所**   | サーバー側セッションストア | クライアント側（トークン内）     |
| **認証情報送信**     | Cookie（自動送信）         | Authorization ヘッダー（明示的） |
| **スケーラビリティ** | 中（外部ストア必要）       | 高（水平スケール容易）           |
| **即座の無効化**     | 容易（セッション削除）     | 困難（ブラックリスト必要）       |
| **トークンサイズ**   | 小（セッション ID のみ）   | 大（情報内包により可変）         |
| **実装複雑度**       | 中（セッション管理）       | 高（トークン管理・更新）         |

---

## 🏗️ アーキテクチャ比較

### セッション/クッキー方式

```
┌─────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Client    │    │     Server       │    │ Session Store   │
│             │    │                  │    │ (Memory/Redis)  │
└─────────────┘    └──────────────────┘    └─────────────────┘
       │                      │                       │
   [1] │ POST /login          │                       │
       │ {user, pass}         │                       │
       ├─────────────────────►│                       │
       │                      │ [2] Verify & Create   │
       │                      │     Session           │
       │                      ├──────────────────────►│
       │                      │                       │
       │   Set-Cookie:        │ [3] Store Session     │
       │   sessionId=abc123   │     Data              │
       │◄─────────────────────┤◄──────────────────────┤
   [4] │                      │                       │
       │ GET /api/todos       │                       │
       │ Cookie: sessionId    │                       │
       ├─────────────────────►│                       │
       │                      │ [5] Lookup Session    │
       │                      ├──────────────────────►│
       │                      │                       │
       │   Response Data      │ [6] Session Found     │
       │◄─────────────────────┤◄──────────────────────┤
```

**特徴**:

- サーバー側でセッション状態を管理
- Cookie による自動送信（CSRF 対策が必要）
- セッションストアが必要（メモリ/Redis/Database）

### JWT 方式

```
┌─────────────┐    ┌──────────────────┐
│   Client    │    │     Server       │
│             │    │   (Stateless)    │
└─────────────┘    └──────────────────┘
       │                      │
   [1] │ POST /login          │
       │ {user, pass}         │
       ├─────────────────────►│
       │                      │ [2] Verify &
       │                      │     Generate JWT
       │                      │
       │   {token: "eyJ..."}  │
       │◄─────────────────────┤
   [3] │ Store JWT locally    │
       │                      │
   [4] │ GET /api/todos       │
       │ Authorization:       │
       │ Bearer eyJ...        │
       ├─────────────────────►│
       │                      │ [5] Verify JWT
       │                      │     (No DB lookup)
       │                      │
       │   Response Data      │
       │◄─────────────────────┤
```

**特徴**:

- サーバー側で状態を持たない（ステートレス）
- Authorization ヘッダーでの明示的送信
- トークン検証のみ（外部ストア不要）

---

## ⚖️ 詳細比較

### 1. 状態管理とスケーラビリティ

#### セッション方式

**メリット**:

- シンプルな実装
- 即座のセッション無効化が可能
- サーバー側で完全な制御

**デメリット**:

- メモリ使用量がセッション数に比例
- 複数サーバー環境では外部ストア必須
- サーバー再起動でセッション消失

**スケール戦略**:

```
Load Balancer + Session Store (Redis)
┌─────────────┐    ┌─────────┐    ┌─────────┐
│    Client   │    │ Server1 │    │ Server2 │
└─────────────┘    └─────────┘    └─────────┘
       │                │              │
       └────────────────┼──────────────┤
                        │              │
                   ┌────▼──────────────▼────┐
                   │    Redis Session      │
                   │       Store           │
                   └───────────────────────┘
```

#### JWT 方式

**メリット**:

- サーバー側状態不要
- 水平スケールが容易
- マイクロサービスアーキテクチャに適合

**デメリット**:

- トークン無効化が困難
- トークンサイズによるネットワーク負荷
- 秘密鍵管理の複雑さ

**スケール戦略**:

```
Load Balancer (No Session Affinity Required)
┌─────────────┐    ┌─────────┐    ┌─────────┐
│    Client   │    │ Server1 │    │ Server2 │
│  JWT Token  │    │(Stateless)  │(Stateless)
└─────────────┘    └─────────┘    └─────────┘
       │                │              │
       └────────────────┼──────────────┤
                        │              │
                        ▼              ▼
                 JWT Verification   JWT Verification
                 (Same Secret Key)  (Same Secret Key)
```

---

### 2. セキュリティ比較

| セキュリティ要素 | セッション/クッキー       | JWT                       |
| :--------------- | :------------------------ | :------------------------ |
| **CSRF 攻撃**    | 脆弱（Cookie 自動送信）   | 耐性（Bearer ヘッダー）   |
| **XSS 攻撃**     | 中程度（HttpOnly Cookie） | 注意（localStorage 保存） |
| **中間者攻撃**   | HTTPS 必須                | HTTPS 必須                |
| **トークン盗難** | セッション無効化で対処    | 期限切れまで有効          |
| **情報漏えい**   | 低（セッション ID のみ）  | 中（Base64 デコード可能） |

#### セッション方式のセキュリティ対策

```javascript
// セキュアなセッション設定
app.use(
  session({
    secret: process.env.SESSION_SECRET,
    resave: false,
    saveUninitialized: false,
    cookie: {
      secure: true, // HTTPS only
      httpOnly: true, // XSS対策
      maxAge: 24 * 60 * 60 * 1000, // 24時間
      sameSite: "strict", // CSRF対策
    },
  })
);
```

#### JWT 方式のセキュリティ対策

```javascript
// JWTの安全な設定
const jwt = require("jsonwebtoken");

// トークン生成
const token = jwt.sign(
  { userId: user.id },
  process.env.JWT_SECRET, // 256bit以上の強力な秘密鍵
  {
    expiresIn: "15m", // 短時間での期限切れ
    issuer: "your-app",
    audience: "your-users",
  }
);

// トークン保存（推奨方法）
// 1. HttpOnly Cookie（CSRF対策とセット）
// 2. localStorage + XSS対策
```

---

### 3. パフォーマンス比較

| パフォーマンス要素 | セッション/クッキー  | JWT                  |
| :----------------- | :------------------- | :------------------- |
| **初回認証**       | 高速（メモリ書込）   | 中速（JWT 生成処理） |
| **認証確認**       | 中速（ストア読取）   | 高速（署名検証のみ） |
| **ネットワーク**   | 軽量（SessionID）    | 重量（Token 全体）   |
| **メモリ使用**     | 高（セッション分）   | 低（状態なし）       |
| **DB 負荷**        | 高（セッション管理） | 低（検証のみ）       |

#### 実測例（仮想）

```
リクエスト処理時間比較:
┌────────────────┬─────────────┬─────────┐
│ 認証方式       │ 認証確認    │ 初回認証 │
├────────────────┼─────────────┼─────────┤
│ Session/Cookie │ 2-5ms      │ 1-3ms   │
│ JWT           │ 0.5-1ms    │ 3-7ms   │
└────────────────┴─────────────┴─────────┘

ネットワーク使用量比較:
┌────────────────┬─────────────────────┐
│ 認証方式       │ リクエストヘッダサイズ   │
├────────────────┼─────────────────────┤
│ Session/Cookie │ ~50 bytes          │
│ JWT           │ ~200-500 bytes     │
└────────────────┴─────────────────────┘
```

---

### 4. 使用場面の判断基準

#### セッション/クッキー方式が適している場面

- **従来型 Web アプリケーション**（サーバーサイドレンダリング）
- **即座の認証無効化が重要**（管理者権限変更等）
- **シンプルな認証要件**（基本的なログイン・ログアウト）
- **小規模〜中規模**のアプリケーション

#### JWT 方式が適している場面

- **API 中心のアプリケーション**（REST API, GraphQL）
- **マイクロサービスアーキテクチャ**
- **SPA（Single Page Application）**
- **モバイルアプリ連携**
- **分散システム・クロスドメイン認証**
- **高スケーラビリティが必要**

---

### 5. 実装・運用コスト比較

| コスト要素   | セッション/クッキー        | JWT                    |
| :----------- | :------------------------- | :--------------------- |
| **初期実装** | 低（フレームワーク標準）   | 中（トークン管理実装） |
| **運用保守** | 中（セッションストア管理） | 中（鍵管理・更新戦略） |
| **インフラ** | 中（Redis 等外部ストア）   | 低（外部依存少）       |
| **デバッグ** | 易（サーバー側で状態確認） | 難（トークン内容解析） |
| **監視**     | 中（セッション数・ストア） | 低（ステートレス）     |

---

## 🚀 学習のポイント

### 重要な理解事項

1. **ステートフル vs ステートレス**の根本的違い
2. **トレードオフの理解**（利便性・セキュリティ・パフォーマンス）
3. **適用場面の判断基準**

### よくある誤解

- ❌ "JWT の方が常に優れている"
- ❌ "セッション方式は古い技術"
- ❌ "どちらか一方しか使えない"

### ✅ 正しい理解

- 用途・要件に応じた適切な選択が重要
- ハイブリッド構成（セッション+JWT）も可能
- セキュリティはどちらも適切な実装が必要

---

## 🔄 次ステップへ

この比較理解により、Step 2-2「JWT 構造解析」でより深い理解が可能になります。

**準備完了チェック**:

- [ ] ステートレス認証の概念理解
- [ ] JWT の利点・欠点の把握
- [ ] セッション方式との違いの理解
- [ ] 適用場面の判断基準の理解

---

_Step 2-1 の理論学習完了後、実際の JWT 内部構造を詳しく学習していきます。_
