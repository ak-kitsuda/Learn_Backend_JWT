# JWT 基礎概念理解シート

## 🎯 学習目標

JWT (JSON Web Token) の存在意義と基本概念を理解し、従来の認証方式との違いを把握する

---

## 1. JWT とは何か？

### 定義

**JSON Web Token (JWT)** は、当事者間で安全に情報を送信するためのコンパクトで URL セーフな方法を定義するオープンスタンダード（RFC 7519）です。

### 基本特徴

- **JSON ベース**: 情報を JSON 形式で格納
- **自己完結型**: トークン自体に必要な情報を含む（Self-contained）
- **デジタル署名**: HMAC アルゴリズムまたは RSA/ECDSA の公開鍵・秘密鍵ペアで署名
- **URL セーフ**: HTTP ヘッダーや URL パラメータで安全に送信可能

### 使用される場面

1. **認証 (Authentication)**: ユーザーのログイン状態管理
2. **認可 (Authorization)**: リソースアクセス権限の確認
3. **情報交換 (Information Exchange)**: 署名により改ざん検証可能な情報共有

### Base64URL エンコーディングの特徴

- 通常の Base64 の `+/=` を `-_` に置換（URL セーフ）
- パディング（`=`）を除去
- HTTP ヘッダーや URL での使用に最適化

**例**: 通常の Base64: `SGVsbG8gV29ybGQ=` → Base64URL: `SGVsbG8gV29ybGQ`

---

## 2. なぜ JWT が必要なのか？

### 従来の課題（セッション/クッキー方式）

#### サーバー状態管理の複雑さ

- **メモリ消費**: 全セッション情報をサーバーメモリに保持
- **単一障害点**: セッションストアが停止すると全ユーザーがログアウト
- **状態同期**: 複数サーバー間でセッション情報の共有が必要

#### スケーラビリティの限界

- **水平スケール困難**: サーバー追加時にセッション情報の共有機構が必要
- **ロードバランサー依存**: セッション粘着（Sticky Session）または外部ストア必須
- **リソース消費**: Redis などの外部セッションストアが必要

### マイクロサービス時代の要求

#### 分散システムでの認証

- **サービス間認証**: 各マイクロサービスが独立して認証判定
- **API ゲートウェイ**: 単一エントリポイントでの認証・認可
- **クロスドメイン**: 異なるドメイン間での認証情報共有

#### 現代的な要求

- **モバイルアプリ対応**: クッキーに依存しない認証方式
- **SPA (Single Page Application)**: JavaScript での柔軟な認証制御
- **RESTful API**: ステートレスな API 設計との整合性

### JWT による解決

- **ステートレス**: サーバー側で状態を持たない
- **自己完結**: トークン内に必要な情報を含む
- **標準化**: RFC 7519 に基づく業界標準
- **プラットフォーム非依存**: 言語・フレームワークを問わず利用可能

---

## 3. JWT の利点と欠点

### ✅ 利点

#### 1. ステートレス認証

- **メモリ効率**: サーバー側でセッション情報不要
- **スケーラビリティ**: 水平スケールが容易
- **単純性**: セッション管理の複雑さを除去

#### 2. 自己完結型

- **情報内包**: ユーザー情報・権限をトークン内に格納可能
- **DB アクセス削減**: 認証時のデータベース問い合わせ不要
- **高速認証**: トークン検証のみで認証判定

#### 3. 標準化・相互運用性

- **業界標準**: RFC 7519 準拠で広く採用
- **ライブラリ豊富**: 主要言語でライブラリが利用可能
- **クロスプラットフォーム**: Web・モバイル・デスクトップで共通利用

#### 4. セキュリティ

- **改ざん検証**: デジタル署名による完全性保証
- **有効期限**: exp クレームによる自動失効
- **カスタムクレーム**: アプリケーション固有の情報格納

### ❌ 欠点

#### 1. トークンサイズ

- **ペイロード肥大**: 情報量に比例してサイズ増加
- **ネットワーク負荷**: 毎回のリクエストでトークン送信
- **制限**: HTTP ヘッダーサイズ制限に注意

#### 2. 無効化の困難さ

- **即座の失効不可**: トークン発行後の取り消しが困難
- **ブラックリスト管理**: 無効化にはサーバー側状態管理が必要
- **セキュリティリスク**: 盗難時の対処が複雑

#### 3. セキュリティリスク

- **XSS 脆弱性**: フロントエンドでの保存場所に注意
- **情報漏えい**: Base64 デコードで内容確認可能
- **秘密鍵管理**: 署名用秘密鍵の適切な管理が必要

#### 4. 実装の複雑さ

- **トークン更新**: リフレッシュトークン機構の実装
- **エラーハンドリング**: 期限切れ・署名不正等の適切な処理
- **セキュリティ対策**: 各種攻撃への対策実装

---

## 4. 実際の使用例

### 認証フロー例

```
1. ユーザーログイン → サーバーがJWT発行
2. クライアントがJWT保存（localStorage/Cookie）
3. API リクエスト時にJWTを送信
4. サーバーがJWT検証 → レスポンス返却
```

### JWT の構造（概要）

```
Header.Payload.Signature
xxxxxxx.yyyyyyy.zzzzzzz
```

- **Header**: アルゴリズム情報（`{"alg":"HS256","typ":"JWT"}`）
- **Payload**: クレーム情報（ユーザー ID、有効期限など）
- **Signature**: 改ざん検証用のデジタル署名

_詳細な構造解析は Step 2-2 で学習します_

---

## 5. 学習のポイント

### 重要な概念

1. **ステートレス vs ステートフル**: 根本的なアーキテクチャの違い
2. **自己完結型**: トークン内に情報を含む設計思想
3. **トレードオフ**: 利便性 vs セキュリティのバランス

### 次ステップへの準備

- JWT の内部構造理解（Header, Payload, Signature）
- 実際のトークン生成・検証方法
- セキュリティベストプラクティス

---

## 6. よくある誤解

### ❌ 間違った理解

- "JWT は暗号化されている" → Base64 エンコードのみ、暗号化ではない
- "JWT は完全に安全" → 適切な実装・運用が必要
- "JWT はセッションの完全上位互換" → 用途により向き不向きがある

### ✅ 正しい理解

- JWT は **署名により完全性を保証**、内容は Base64 デコードで確認可能
- **適切な実装と運用**により安全性を確保
- **用途に応じた選択**が重要（セッション vs JWT）

---

_このシートで JWT の基本概念を理解できたら、Step 2-2 で詳細な構造解析に進みましょう。_
